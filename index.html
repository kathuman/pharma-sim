<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharma Supply Chain Simulator - Executive Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom": "https://esm.sh/react-dom@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "recharts": "https://esm.sh/recharts@2.12.2?external=react,react-dom",
                "lucide-react": "https://esm.sh/lucide-react@0.344.0?external=react"
            }
        }
    </script>

    <style>
        body { font-family: system-ui, -apple-system, sans-serif; }
        .chart-container { background: white; border-radius: 0.75rem; border: 1px solid #e2e8f0; padding: 1.5rem; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
        
        /* Toggle Switch CSS */
        .toggle-checkbox:checked { right: 0; border-color: #3b82f6; }
        .toggle-checkbox:checked + .toggle-label { background-color: #3b82f6; }
        .toggle-checkbox { right: 0; z-index: 1; border-color: #e2e8f0; transition: all 0.3s; }
        .toggle-label { background-color: #cbd5e1; transition: all 0.3s; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import {
            LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend,
            ResponsiveContainer, AreaChart, Area, ReferenceLine, ComposedChart, Bar
        } from 'recharts';
        import {
            Settings, RefreshCw, Activity, Package, AlertOctagon, TrendingUp, 
            DollarSign, Percent, ShieldAlert, GitMerge, BookmarkPlus
        } from 'lucide-react';

        // --- Simulation Engine ---

        const runSimulation = (params) => {
            const {
                // Environment
                initialDemand, shockWeek, shockMagnitude, noiseLevel,
                // Supply Chain Physics
                productivity, shelfLife, qaDelayTime, targetCoverage, 
                timeToCorrectInv, timeToAdjustWf, avgEmploymentTime, timeToAvgShipments,
                // Financials
                price, cost, holdingCost, stockPenalty, wasteCost,
                // Policy Levers
                useOvertime, expediteQA, multiEchelon
            } = params;

            const dt = 0.20; 
            const weeks = 52;
            const steps = Math.floor(weeks / dt);
            const data = [];

            // Equilibrium Initialization
            const eqDemand = initialDemand;
            const eqInventory = eqDemand * targetCoverage;
            const eqExpiration = eqInventory / shelfLife;
            const eqProduction = eqDemand + eqExpiration;
            const eqQuarantine = eqProduction * qaDelayTime;
            const eqWorkforce = eqProduction / productivity;

            // Manufacturer State
            let inventory = eqInventory;
            let quarantine = eqQuarantine;
            let workforce = eqWorkforce;
            let avgShipmentRate = eqDemand;
            
            // Retailer State (If Multi-Echelon)
            let retailInventory = eqInventory;
            let retailAvgDemand = eqDemand;

            // Cumulative Metrics
            let cumulativeWaste = 0;
            let cumulativeProfit = 0;
            let totalMarketDemand = 0;
            let totalMarketShipments = 0;

            for (let t = 0; t < steps; t++) {
                const time = t * dt;

                // 1. Stochastic Demand Shock
                const baseDemand = time >= shockWeek ? initialDemand * shockMagnitude : initialDemand;
                // Simple pseudo-random noise approximation (-1 to 1)
                const randomNoise = (Math.random() * 2 - 1) * noiseLevel;
                const actualMarketDemand = Math.max(0, baseDemand * (1 + randomNoise));

                let manufacturerDemand = actualMarketDemand;
                let marketShipment = 0;

                // 2. Multi-Echelon Logic (Retailer orders from Manufacturer)
                if (multiEchelon) {
                    marketShipment = Math.min(actualMarketDemand, retailInventory / dt);
                    
                    // Retailer Forecasting (Exponential Smoothing)
                    const changeInAvg = (marketShipment - retailAvgDemand) / timeToAvgShipments;
                    retailAvgDemand += changeInAvg * dt;
                    
                    // Retailer Ordering Policy
                    const retailDesiredInv = retailAvgDemand * targetCoverage;
                    const retailInvGap = retailDesiredInv - retailInventory;
                    let retailOrder = retailAvgDemand + (retailInvGap / timeToCorrectInv);
                    
                    manufacturerDemand = Math.max(0, retailOrder); // Passes bullwhip upstream
                }

                // 3. Manufacturer Shipment
                const maxShipment = inventory / dt;
                const actualShipment = Math.min(manufacturerDemand, maxShipment);
                const missedSales = Math.max(0, manufacturerDemand - maxShipment);
                
                if (!multiEchelon) {
                    marketShipment = actualShipment; // Direct to market
                } else {
                    retailInventory += (actualShipment - marketShipment) * dt; // Replenish retail
                }

                // Financial Tracking Core Metrics
                totalMarketDemand += actualMarketDemand * dt;
                totalMarketShipments += marketShipment * dt;

                // Manufacturer Forecasting
                const changeInMfgAvg = (actualShipment - avgShipmentRate) / timeToAvgShipments;
                avgShipmentRate += changeInMfgAvg * dt;

                // 4. Policy Levers (Interventions)
                let currentProdMultiplier = 1.0;
                let currentCostMultiplier = 1.0;
                let currentQADelay = qaDelayTime;
                let currentWasteMultiplier = 1.0;

                // Overtime Lever
                const desiredInventory = avgShipmentRate * targetCoverage;
                if (useOvertime && inventory < desiredInventory * 0.8) {
                    currentProdMultiplier = 1.20; // 20% bump in productivity
                    currentCostMultiplier = 1.50; // Time-and-a-half cost
                }

                // Expedite QA Lever
                if (expediteQA) {
                    currentQADelay = Math.max(0.1, qaDelayTime * 0.5); // Halve the delay
                    currentWasteMultiplier = 1.25; // 25% higher expiration rate due to rushed quality
                }

                // 5. Production Planning
                const invGap = desiredInventory - inventory;
                const invCorrection = invGap / timeToCorrectInv;
                const currentExpiration = (inventory / shelfLife) * currentWasteMultiplier;
                
                const targetProduction = avgShipmentRate + invCorrection + currentExpiration;
                const desiredProduction = Math.max(0, targetProduction);

                // 6. Workforce Dynamics
                const effectiveProductivity = productivity * currentProdMultiplier;
                const desiredWorkforce = desiredProduction / effectiveProductivity;
                const wfGap = desiredWorkforce - workforce;
                const departures = workforce / avgEmploymentTime;
                const hiring = (wfGap / timeToAdjustWf) + departures;
                const hiringRate = Math.max(0, hiring);
                
                workforce += (hiringRate - departures) * dt;

                // 7. Production & QA State Updates
                const actualProduction = workforce * effectiveProductivity;
                const qaApproval = quarantine / currentQADelay;
                
                quarantine += (actualProduction - qaApproval) * dt;
                inventory += (qaApproval - actualShipment - currentExpiration) * dt;
                
                cumulativeWaste += currentExpiration * dt;

                // 8. Financial Accounting
                const rev = actualShipment * price;
                const pCost = actualProduction * cost * currentCostMultiplier;
                const hCost = inventory * holdingCost;
                const mCost = missedSales * stockPenalty;
                const wCost = currentExpiration * wasteCost;

                const stepProfit = (rev - pCost - hCost - mCost - wCost) * dt;
                cumulativeProfit += stepProfit;

                data.push({
                    time: parseFloat(time.toFixed(1)),
                    marketDemand: Math.round(actualMarketDemand),
                    manufacturerDemand: Math.round(manufacturerDemand),
                    productionRate: Math.round(actualProduction),
                    inventory: Math.round(inventory),
                    retailInventory: multiEchelon ? Math.round(retailInventory) : 0,
                    quarantine: Math.round(quarantine),
                    cumulativeProfit: Math.round(cumulativeProfit),
                    cumulativeWaste: Math.round(cumulativeWaste),
                    fillRate: totalMarketDemand > 0 ? (totalMarketShipments / totalMarketDemand) * 100 : 100
                });
            }
            return data;
        };

        // --- UI Components ---

        const Slider = ({ label, value, min, max, step, onChange, unit }) => (
            <div className="mb-4">
                <div className="flex justify-between text-sm mb-1">
                    <span className="font-medium text-slate-700">{label}</span>
                    <span className="text-slate-500 font-mono">{value} {unit}</span>
                </div>
                <input type="range" min={min} max={max} step={step} value={value}
                    onChange={(e) => onChange(parseFloat(e.target.value))}
                    className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                />
            </div>
        );

        const Toggle = ({ label, checked, onChange, description }) => (
            <div className="mb-4 flex items-start justify-between">
                <div>
                    <span className="font-medium text-sm text-slate-700">{label}</span>
                    {description && <p className="text-xs text-slate-500 mt-0.5 max-w-[200px]">{description}</p>}
                </div>
                <div className="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in mt-1">
                    <input type="checkbox" checked={checked} onChange={(e) => onChange(e.target.checked)}
                        className="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer" />
                    <label className="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label>
                </div>
            </div>
        );

        const MetricCard = ({ title, value, subtext, icon: Icon, color, isCurrency = false }) => (
            <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-start space-x-3">
                <div className={`p-2 rounded-lg ${color} text-white`}><Icon size={20} /></div>
                <div>
                    <div className="text-xs font-bold text-slate-500 uppercase tracking-wide">{title}</div>
                    <div className={`text-2xl font-bold mt-0.5 ${isCurrency && value < 0 ? 'text-red-600' : 'text-slate-800'}`}>
                        {isCurrency ? (value < 0 ? `-$${Math.abs(value).toLocaleString()}` : `$${value.toLocaleString()}`) : value}
                    </div>
                    <div className="text-xs text-slate-400 mt-1">{subtext}</div>
                </div>
            </div>
        );

        // --- Main Application ---

        const App = () => {
            const defaults = {
                // Environment
                initialDemand: 1000, shockWeek: 10, shockMagnitude: 1.20, noiseLevel: 0.05,
                // Supply Chain
                productivity: 5, shelfLife: 50, qaDelayTime: 3, targetCoverage: 4, 
                timeToCorrectInv: 8, timeToAdjustWf: 8, avgEmploymentTime: 50, timeToAvgShipments: 8,
                // Financials (Fixed for this sim)
                price: 100, cost: 40, holdingCost: 0.5, stockPenalty: 150, wasteCost: 60,
                // Levers
                useOvertime: false, expediteQA: false, multiEchelon: false
            };

            const [params, setParams] = useState(defaults);
            const [baselineData, setBaselineData] = useState(null);

            const data = useMemo(() => runSimulation(params), [params]);

            // Chart Data Mapping (Combining current run with baseline if it exists)
            const chartData = useMemo(() => {
                return data.map((d, index) => ({
                    ...d,
                    baseProfit: baselineData ? baselineData[index].cumulativeProfit : null,
                    baseInv: baselineData ? baselineData[index].inventory : null
                }));
            }, [data, baselineData]);

            // Top KPIs
            const finalProfit = data[data.length - 1].cumulativeProfit;
            const finalFillRate = data[data.length - 1].fillRate.toFixed(1);
            const totalWaste = data[data.length - 1].cumulativeWaste;
            
            const peakDemand = Math.max(...data.map(d => d.marketDemand));
            const peakMfgDemand = Math.max(...data.map(d => d.manufacturerDemand));
            const peakProd = Math.max(...data.map(d => d.productionRate));
            
            // Calculate Bullwhip Ratio (Production Peak vs Market Demand Peak)
            const dIncrease = peakDemand - params.initialDemand;
            const pIncrease = peakProd - params.initialDemand;
            const bullwhip = dIncrease > 0 ? (pIncrease / dIncrease).toFixed(2) : "1.00";

            const saveBaseline = () => setBaselineData(data);
            const clearBaseline = () => setBaselineData(null);

            return (
                <div className="min-h-screen pb-12">
                    <nav className="bg-white border-b border-slate-200 sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center space-x-2">
                                <Activity className="text-blue-600" />
                                <span className="font-bold text-slate-900 text-lg">PharmaSim <span className="font-normal text-slate-500">Executive</span></span>
                            </div>
                            <div className="flex space-x-3">
                                <button onClick={() => setParams(defaults)} className="flex items-center px-3 py-1.5 text-sm font-medium text-slate-600 hover:text-red-600">
                                    <RefreshCw size={16} className="mr-2" /> Reset Defaults
                                </button>
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-7xl mx-auto px-4 py-8">
                        
                        {/* Executive KPI Dash */}
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                            <MetricCard 
                                title="Annual Profit" value={finalProfit} isCurrency={true}
                                subtext="Revenue minus all operating costs" icon={DollarSign} color="bg-emerald-600" 
                            />
                            <MetricCard 
                                title="Order Fill Rate" value={`${finalFillRate}%`} 
                                subtext="Customer demand successfully met" icon={Percent} 
                                color={finalFillRate < 90 ? "bg-red-500" : "bg-blue-500"} 
                            />
                            <MetricCard 
                                title="Bullwhip Effect" value={`${bullwhip}x`} 
                                subtext="Supply fluctuation vs Market fluctuation" icon={TrendingUp} 
                                color={parseFloat(bullwhip) > 1.5 ? "bg-orange-500" : "bg-slate-500"} 
                            />
                            <MetricCard 
                                title="Total Waste Cost" value={totalWaste * params.wasteCost} isCurrency={true}
                                subtext="Value of expired goods" icon={AlertOctagon} color="bg-rose-500" 
                            />
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                            
                            {/* Controls Left Column */}
                            <div className="lg:col-span-4 space-y-6">
                                
                                {/* Market & Environment */}
                                <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                                    <h3 className="font-semibold text-slate-800 flex items-center mb-4 border-b border-slate-100 pb-2">
                                        <Activity size={18} className="mr-2 text-blue-500" /> Market Environment
                                    </h3>
                                    <Slider label="Shock Magnitude" value={Math.round((params.shockMagnitude - 1) * 100)} min={0} max={50} step={5} unit="%" 
                                        onChange={(v) => setParams(p => ({...p, shockMagnitude: 1 + v/100}))} />
                                    <Slider label="Demand Volatility (Noise)" value={params.noiseLevel * 100} min={0} max={20} step={1} unit="%" 
                                        onChange={(v) => setParams(p => ({...p, noiseLevel: v/100}))} />
                                </div>

                                {/* Network Config */}
                                <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                                    <h3 className="font-semibold text-slate-800 flex items-center mb-4 border-b border-slate-100 pb-2">
                                        <GitMerge size={18} className="mr-2 text-indigo-500" /> Network Architecture
                                    </h3>
                                    <Toggle 
                                        label="Enable Retail Tier (Multi-Echelon)" 
                                        description="Adds a distributor between market and factory. Watch the bullwhip explode."
                                        checked={params.multiEchelon} 
                                        onChange={(v) => setParams(p => ({...p, multiEchelon: v}))} 
                                    />
                                    <Slider label="QA Delay" value={params.qaDelayTime} min={1} max={8} step={1} unit="wks" 
                                        onChange={(v) => setParams(p => ({...p, qaDelayTime: v}))} />
                                </div>

                                {/* Executive Policy Interventions */}
                                <div className="bg-white p-5 rounded-xl border border-blue-200 shadow-sm relative overflow-hidden">
                                    <div className="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                                    <h3 className="font-semibold text-slate-800 flex items-center mb-4 border-b border-slate-100 pb-2">
                                        <ShieldAlert size={18} className="mr-2 text-blue-500" /> Policy Interventions
                                    </h3>
                                    <Toggle 
                                        label="Emergency Overtime" 
                                        description="Boosts prod by 20% when stock drops, but increases labor cost by 50%."
                                        checked={params.useOvertime} 
                                        onChange={(v) => setParams(p => ({...p, useOvertime: v}))} 
                                    />
                                    <Toggle 
                                        label="Expedite QA Process" 
                                        description="Halves QA delay to rush stock, but increases defect/waste rate by 25%."
                                        checked={params.expediteQA} 
                                        onChange={(v) => setParams(p => ({...p, expediteQA: v}))} 
                                    />
                                </div>

                            </div>

                            {/* Charts Right Column */}
                            <div className="lg:col-span-8 space-y-6">
                                
                                {/* Compare Header */}
                                <div className="flex justify-between items-center bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                    <div className="text-sm text-slate-600">
                                        {baselineData ? 
                                            <span className="flex items-center text-emerald-600 font-medium"><BookmarkPlus size={16} className="mr-2"/> Baseline Saved. Compare your interventions.</span> : 
                                            "Save a baseline to compare the financial impact of your policy changes."}
                                    </div>
                                    <div className="space-x-2">
                                        <button onClick={saveBaseline} className="px-3 py-1.5 bg-slate-800 text-white text-sm rounded hover:bg-slate-700 transition">Save Baseline</button>
                                        {baselineData && <button onClick={clearBaseline} className="px-3 py-1.5 bg-slate-200 text-slate-700 text-sm rounded hover:bg-slate-300 transition">Clear</button>}
                                    </div>
                                </div>

                                {/* Chart 1: The Bullwhip */}
                                <div className="chart-container">
                                    <div className="mb-4">
                                        <h3 className="text-lg font-bold text-slate-800">Demand Amplification (The Bullwhip)</h3>
                                        <p className="text-sm text-slate-500">Notice how stochastic market demand amplifies as it moves upstream to the manufacturer.</p>
                                    </div>
                                    <div className="h-72">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <ComposedChart data={chartData}>
                                                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                                <XAxis dataKey="time" tick={{fill: '#94a3b8'}} tickLine={false} />
                                                <YAxis tick={{fill: '#94a3b8'}} tickLine={false} />
                                                <Tooltip contentStyle={{ borderRadius: '8px' }} />
                                                <Legend />
                                                <ReferenceLine x={params.shockWeek} stroke="#cbd5e1" strokeDasharray="3 3" />
                                                <Line type="monotone" dataKey="marketDemand" name="Actual Market Demand" stroke="#64748b" strokeWidth={2} dot={false} />
                                                {params.multiEchelon && <Line type="step" dataKey="manufacturerDemand" name="Retail Orders to Mfg" stroke="#f59e0b" strokeWidth={2} dot={false} strokeDasharray="4 4" />}
                                                <Line type="monotone" dataKey="productionRate" name="Mfg Production Rate" stroke="#3b82f6" strokeWidth={3} dot={false} />
                                            </ComposedChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>

                                {/* Dual Charts: Finances & Inventory */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className="chart-container">
                                        <h4 className="font-bold text-slate-800 mb-2">Cumulative Profit ($)</h4>
                                        <div className="h-48">
                                            <ResponsiveContainer width="100%" height="100%">
                                                <ComposedChart data={chartData}>
                                                    <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                                    <XAxis dataKey="time" tick={{fontSize: 10}} tickLine={false} />
                                                    <YAxis tick={{fontSize: 10}} tickLine={false} tickFormatter={(val) => `$${val/1000}k`} />
                                                    <Tooltip formatter={(value) => `$${value.toLocaleString()}`} />
                                                    {baselineData && <Line type="monotone" dataKey="baseProfit" name="Baseline Profit" stroke="#94a3b8" strokeWidth={2} strokeDasharray="4 4" dot={false} />}
                                                    <Line type="monotone" dataKey="cumulativeProfit" name="Current Profit" stroke="#10b981" strokeWidth={3} dot={false} />
                                                </ComposedChart>
                                            </ResponsiveContainer>
                                        </div>
                                    </div>

                                    <div className="chart-container">
                                        <h4 className="font-bold text-slate-800 mb-2">Available Inventory (Mfg)</h4>
                                        <div className="h-48">
                                            <ResponsiveContainer width="100%" height="100%">
                                                <ComposedChart data={chartData}>
                                                    <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                                    <XAxis dataKey="time" tick={{fontSize: 10}} tickLine={false} />
                                                    <YAxis tick={{fontSize: 10}} tickLine={false} />
                                                    <Tooltip />
                                                    {baselineData && <Line type="monotone" dataKey="baseInv" name="Baseline Inv" stroke="#94a3b8" strokeWidth={2} strokeDasharray="4 4" dot={false} />}
                                                    <Area type="monotone" dataKey="inventory" name="Current Inv" stroke="#8b5cf6" fill="#8b5cf6" fillOpacity={0.2} />
                                                </ComposedChart>
                                            </ResponsiveContainer>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
