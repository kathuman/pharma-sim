<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharma Supply Chain Simulator - Advanced</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map to fix React Version Conflicts -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom": "https://esm.sh/react-dom@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "recharts": "https://esm.sh/recharts@2.12.2?external=react,react-dom",
                "lucide-react": "https://esm.sh/lucide-react@0.344.0?external=react"
            }
        }
    </script>

    <style>
        body { font-family: system-ui, -apple-system, sans-serif; }
        .chart-container { background: white; border-radius: 0.75rem; border: 1px solid #e2e8f0; padding: 1.5rem; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import {
            LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend,
            ResponsiveContainer, AreaChart, Area, ReferenceLine, ComposedChart, Bar
        } from 'recharts';
        import {
            Settings, RefreshCw, Activity, Users, Package, AlertTriangle, 
            Info, Download, TrendingUp, AlertOctagon
        } from 'lucide-react';

        // --- Simulation Engine ---

        const runSimulation = (params) => {
            const {
                initialDemand, shockWeek, shockMagnitude, productivity,
                shelfLife, qaDelayTime, targetCoverage, timeToCorrectInv,
                timeToAdjustWf, avgEmploymentTime, timeToAvgShipments,
            } = params;

            const dt = 0.20; 
            const weeks = 52;
            const steps = Math.floor(weeks / dt);
            const data = [];

            // Equilibrium Initialization
            const eqDemand = initialDemand;
            const eqInventory = eqDemand * targetCoverage;
            const eqExpiration = eqInventory / shelfLife;
            const eqProduction = eqDemand + eqExpiration;
            const eqQuarantine = eqProduction * qaDelayTime;
            const eqWorkforce = eqProduction / productivity;

            let inventory = eqInventory;
            let quarantine = eqQuarantine;
            let workforce = eqWorkforce;
            let avgShipmentRate = eqDemand;
            let cumulativeWaste = 0;

            for (let t = 0; t < steps; t++) {
                const time = t * dt;

                // 1. Demand Shock
                const currentDemand = time >= shockWeek ? initialDemand * shockMagnitude : initialDemand;

                // 2. Shipment & Perception
                const maxShipment = inventory / dt; // Cannot ship more than stock
                const actualShipment = Math.min(currentDemand, maxShipment);
                const missedSales = Math.max(0, currentDemand - maxShipment);
                
                // Exponential Smoothing for Demand Forecasting
                const changeInAvg = (actualShipment - avgShipmentRate) / timeToAvgShipments;
                const nextAvgShipmentRate = avgShipmentRate + changeInAvg * dt;

                // 3. Production Planning
                const desiredInventory = nextAvgShipmentRate * targetCoverage;
                const invGap = desiredInventory - inventory;
                const invCorrection = invGap / timeToCorrectInv;
                const currentExpiration = inventory / shelfLife;
                
                const targetProduction = nextAvgShipmentRate + invCorrection + currentExpiration;
                const desiredProduction = Math.max(0, targetProduction);

                // 4. Workforce Dynamics
                const desiredWorkforce = desiredProduction / productivity;
                const wfGap = desiredWorkforce - workforce;
                const departures = workforce / avgEmploymentTime;
                const hiring = (wfGap / timeToAdjustWf) + departures;
                const hiringRate = Math.max(0, hiring);
                
                const nextWorkforce = workforce + (hiringRate - departures) * dt;

                // 5. Production & QA
                const actualProduction = workforce * productivity;
                const qaApproval = quarantine / qaDelayTime; // Outflow from QA
                
                const nextQuarantine = quarantine + (actualProduction - qaApproval) * dt;
                const nextInventory = inventory + (qaApproval - actualShipment - currentExpiration) * dt;
                
                cumulativeWaste += currentExpiration * dt;

                data.push({
                    time: parseFloat(time.toFixed(1)),
                    marketDemand: Math.round(currentDemand),
                    productionRate: Math.round(actualProduction),
                    inventory: Math.round(inventory),
                    quarantine: Math.round(quarantine),
                    workforce: Math.round(workforce),
                    qaApproval: Math.round(qaApproval),
                    expirationRate: parseFloat(currentExpiration.toFixed(1)),
                    cumulativeWaste: Math.round(cumulativeWaste),
                    missedSales: Math.round(missedSales)
                });

                inventory = nextInventory;
                quarantine = nextQuarantine;
                workforce = nextWorkforce;
                avgShipmentRate = nextAvgShipmentRate;
            }
            return data;
        };

        // --- UI Components ---

        const Slider = ({ label, value, min, max, step, onChange, unit }) => (
            <div className="mb-4">
                <div className="flex justify-between text-sm mb-1">
                    <span className="font-medium text-slate-700">{label}</span>
                    <span className="text-slate-500 font-mono">{value} {unit}</span>
                </div>
                <input type="range" min={min} max={max} step={step} value={value}
                    onChange={(e) => onChange(parseFloat(e.target.value))}
                    className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                />
            </div>
        );

        const MetricCard = ({ title, value, subtext, icon: Icon, color }) => (
            <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-start space-x-3">
                <div className={`p-2 rounded-lg ${color} text-white`}><Icon size={20} /></div>
                <div>
                    <div className="text-xs font-bold text-slate-500 uppercase tracking-wide">{title}</div>
                    <div className="text-2xl font-bold text-slate-800 mt-0.5">{value}</div>
                    <div className="text-xs text-slate-400 mt-1">{subtext}</div>
                </div>
            </div>
        );

        const ScenarioButton = ({ label, active, onClick }) => (
            <button onClick={onClick}
                className={`px-3 py-2 text-xs font-medium rounded-lg transition-colors border ${
                    active ? 'bg-blue-50 border-blue-200 text-blue-700' : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50'
                }`}
            >
                {label}
            </button>
        );

        // --- Main Application ---

        const App = () => {
            const defaults = {
                initialDemand: 1000,
                shockWeek: 10,
                shockMagnitude: 1.10,
                productivity: 5,
                shelfLife: 50,
                qaDelayTime: 2,
                targetCoverage: 4,
                timeToCorrectInv: 8,
                timeToAdjustWf: 8,
                avgEmploymentTime: 50,
                timeToAvgShipments: 8,
            };

            const [params, setParams] = useState(defaults);
            const [scenario, setScenario] = useState('Standard');

            const data = useMemo(() => runSimulation(params), [params]);

            // Metrics
            const peakProd = Math.max(...data.map(d => d.productionRate));
            const peakDemand = Math.max(...data.map(d => d.marketDemand));
            const totalWaste = data[data.length - 1].cumulativeWaste;
            const maxInv = Math.max(...data.map(d => d.inventory));
            
            // Bullwhip Calculation
            const dIncrease = peakDemand - params.initialDemand;
            const pIncrease = peakProd - params.initialDemand;
            const bullwhip = dIncrease > 0 ? (pIncrease / dIncrease).toFixed(2) : "1.00";

            // Scenarios
            const applyScenario = (type) => {
                setScenario(type);
                let newParams = { ...defaults };
                switch(type) {
                    case 'Pandemic':
                        newParams.shockMagnitude = 1.30; // 30% spike
                        newParams.targetCoverage = 6;    // Hoarding
                        break;
                    case 'Quality Crisis':
                        newParams.qaDelayTime = 6;       // 6 week delay
                        break;
                    case 'Workforce Shortage':
                        newParams.timeToAdjustWf = 16;   // Hard to hire
                        break;
                    default:
                        break;
                }
                setParams(newParams);
            };

            // Download CSV
            const downloadCSV = () => {
                const headers = Object.keys(data[0]).join(',');
                const rows = data.map(obj => Object.values(obj).join(',')).join('\n');
                const blob = new Blob([headers + '\n' + rows], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'pharma_simulation_data.csv';
                a.click();
            };

            return (
                <div className="min-h-screen pb-12">
                    {/* Navbar */}
                    <nav className="bg-white border-b border-slate-200 sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center space-x-2">
                                <Activity className="text-blue-600" />
                                <span className="font-bold text-slate-900 text-lg">PharmaSim</span>
                                <span className="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full font-medium">v2.0</span>
                            </div>
                            <div className="flex space-x-2">
                                <button onClick={downloadCSV} className="flex items-center px-3 py-1.5 text-sm font-medium text-slate-600 hover:text-blue-600 transition-colors">
                                    <Download size={16} className="mr-2" /> Export Data
                                </button>
                                <button onClick={() => applyScenario('Standard')} className="flex items-center px-3 py-1.5 text-sm font-medium text-slate-600 hover:text-red-600 transition-colors">
                                    <RefreshCw size={16} className="mr-2" /> Reset
                                </button>
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-7xl mx-auto px-4 py-8">
                        
                        {/* App Description */}
                        <div className="mb-8 bg-blue-50 border border-blue-100 p-6 rounded-xl">
                            <h2 className="text-xl font-bold text-slate-800 mb-2">About this Simulator</h2>
                            <p className="text-slate-600 leading-relaxed">
                                This interactive tool models the complex dynamics of a pharmaceutical supply chain using System Dynamics principles. 
                                It demonstrates the <strong>"Bullwhip Effect"</strong>â€”where small changes in market demand (shocks) amplify into massive fluctuations in production, inventory, and waste due to delays in information, quality assurance (QA), and workforce hiring. by Daniel Sepulveda kathuman@gmail.com. 2026
                            </p>
                        </div>

                        {/* Top Metrics */}
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                            <MetricCard 
                                title="Bullwhip Effect" 
                                value={`${bullwhip}x`} 
                                subtext="Amplification of demand shock"
                                icon={TrendingUp} 
                                color={parseFloat(bullwhip) > 2 ? "bg-red-500" : "bg-blue-500"} 
                            />
                            <MetricCard 
                                title="Total Waste" 
                                value={totalWaste.toLocaleString()} 
                                subtext="Units expired this year"
                                icon={AlertOctagon} 
                                color="bg-orange-500" 
                            />
                            <MetricCard 
                                title="Peak Inventory" 
                                value={maxInv.toLocaleString()} 
                                subtext="Max warehouse capacity used"
                                icon={Package} 
                                color="bg-emerald-500" 
                            />
                            <MetricCard 
                                title="Production Peak" 
                                value={peakProd.toLocaleString()} 
                                subtext="Max weekly output"
                                icon={Settings} 
                                color="bg-indigo-500" 
                            />
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                            
                            {/* Controls Column */}
                            <div className="lg:col-span-4 space-y-6">
                                <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                    <div className="flex items-center justify-between mb-6">
                                        <h3 className="font-semibold text-slate-800 flex items-center">
                                            <Settings size={18} className="mr-2 text-slate-400" /> 
                                            Parameters
                                        </h3>
                                        <div className="flex space-x-1">
                                            {['Pandemic', 'Quality Crisis', 'Workforce Shortage'].map(s => (
                                                <button key={s} 
                                                    onClick={() => applyScenario(s)}
                                                    title={`Apply ${s} Scenario`}
                                                    className={`w-2 h-2 rounded-full ${scenario === s ? 'bg-blue-500 ring-2 ring-blue-200' : 'bg-slate-200 hover:bg-slate-300'}`}
                                                />
                                            ))}
                                        </div>
                                    </div>

                                    <div className="space-y-6">
                                        <div className="bg-slate-50 p-4 rounded-lg border border-slate-100">
                                            <div className="text-xs font-bold text-slate-400 uppercase mb-4">Demand Shock</div>
                                            <Slider label="Shock Magnitude" value={Math.round((params.shockMagnitude - 1) * 100)} min={0} max={50} step={5} unit="%" 
                                                onChange={(v) => setParams(p => ({...p, shockMagnitude: 1 + v/100}))} />
                                            <Slider label="Shock Week" value={params.shockWeek} min={0} max={40} step={1} unit="wk" 
                                                onChange={(v) => setParams(p => ({...p, shockWeek: v}))} />
                                        </div>

                                        <div className="bg-slate-50 p-4 rounded-lg border border-slate-100">
                                            <div className="text-xs font-bold text-slate-400 uppercase mb-4">Supply Chain Constraints</div>
                                            <Slider label="QA Delay" value={params.qaDelayTime} min={0} max={12} step={1} unit="wks" 
                                                onChange={(v) => setParams(p => ({...p, qaDelayTime: v}))} />
                                            <Slider label="Hiring Lag" value={params.timeToAdjustWf} min={1} max={24} step={1} unit="wks" 
                                                onChange={(v) => setParams(p => ({...p, timeToAdjustWf: v}))} />
                                            <Slider label="Shelf Life" value={params.shelfLife} min={10} max={100} step={5} unit="wks" 
                                                onChange={(v) => setParams(p => ({...p, shelfLife: v}))} />
                                        </div>
                                    </div>

                                    <div className="mt-6 flex flex-wrap gap-2">
                                        {['Standard', 'Pandemic', 'Quality Crisis', 'Workforce Shortage'].map(s => (
                                            <ScenarioButton key={s} label={s} active={scenario === s} onClick={() => applyScenario(s)} />
                                        ))}
                                    </div>
                                </div>

                                <div className="bg-blue-50 border border-blue-100 p-5 rounded-xl text-sm text-blue-800">
                                    <div className="font-semibold flex items-center mb-2"><Info size={16} className="mr-2"/> Insight</div>
                                    In the <strong>{scenario}</strong> scenario, notice how the gap between Production (Blue) and Demand (Black) widens. This "overshoot" causes the massive accumulation of Waste shown in the orange chart.
                                </div>
                            </div>

                            {/* Charts Column */}
                            <div className="lg:col-span-8 space-y-6">
                                
                                {/* Chart 1: The Bullwhip */}
                                <div className="chart-container">
                                    <div className="mb-4">
                                        <h3 className="text-lg font-bold text-slate-800">Production vs. Demand</h3>
                                        <p className="text-sm text-slate-500">The "Bullwhip Effect" is visible where the blue line overshoots the dotted black line.</p>
                                    </div>
                                    <div className="h-64">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <ComposedChart data={data}>
                                                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                                <XAxis dataKey="time" label={{ value: 'Weeks', position: 'insideBottomRight', offset: -5 }} tick={{fill: '#94a3b8'}} tickLine={false} />
                                                <YAxis tick={{fill: '#94a3b8'}} tickLine={false} />
                                                <Tooltip contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} />
                                                <Legend iconType="circle" />
                                                <ReferenceLine x={params.shockWeek} stroke="#ef4444" strokeDasharray="3 3" />
                                                <Line type="monotone" dataKey="marketDemand" name="Market Demand" stroke="#1e293b" strokeWidth={2} dot={false} strokeDasharray="5 5" />
                                                <Line type="monotone" dataKey="productionRate" name="Production Rate" stroke="#3b82f6" strokeWidth={3} dot={false} />
                                            </ComposedChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>

                                {/* Chart 2: Inventory Composition */}
                                <div className="chart-container">
                                    <div className="mb-4">
                                        <h3 className="text-lg font-bold text-slate-800">Inventory Levels</h3>
                                        <p className="text-sm text-slate-500">Available stock vs. products stuck in Quarantine (QA).</p>
                                    </div>
                                    <div className="h-64">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <AreaChart data={data}>
                                                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                                <XAxis dataKey="time" tick={{fill: '#94a3b8'}} tickLine={false} />
                                                <YAxis tick={{fill: '#94a3b8'}} tickLine={false} />
                                                <Tooltip contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} />
                                                <Legend iconType="circle" />
                                                <Area type="monotone" dataKey="inventory" name="Available Inventory" stackId="1" stroke="#10b981" fill="#10b981" fillOpacity={0.2} />
                                                <Area type="monotone" dataKey="quarantine" name="Quarantine (QA)" stackId="1" stroke="#8b5cf6" fill="#8b5cf6" fillOpacity={0.2} />
                                            </AreaChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>

                                {/* Chart 3: Waste & Workforce */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className="chart-container">
                                        <h4 className="font-bold text-slate-800 mb-2">Cumulative Waste</h4>
                                        <div className="h-48">
                                            <ResponsiveContainer width="100%" height="100%">
                                                <AreaChart data={data}>
                                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                                    <XAxis dataKey="time" tick={{fontSize: 10}} tickLine={false} />
                                                    <YAxis tick={{fontSize: 10}} tickLine={false} />
                                                    <Tooltip />
                                                    <Area type="monotone" dataKey="cumulativeWaste" name="Expired Units" stroke="#f97316" fill="#f97316" fillOpacity={0.2} />
                                                </AreaChart>
                                            </ResponsiveContainer>
                                        </div>
                                    </div>
                                    <div className="chart-container">
                                        <h4 className="font-bold text-slate-800 mb-2">Workforce Size</h4>
                                        <div className="h-48">
                                            <ResponsiveContainer width="100%" height="100%">
                                                <LineChart data={data}>
                                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                                    <XAxis dataKey="time" tick={{fontSize: 10}} tickLine={false} />
                                                    <YAxis domain={['auto', 'auto']} tick={{fontSize: 10}} tickLine={false} />
                                                    <Tooltip />
                                                    <Line type="monotone" dataKey="workforce" name="Workers" stroke="#64748b" strokeWidth={2} dot={false} />
                                                </LineChart>
                                            </ResponsiveContainer>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


